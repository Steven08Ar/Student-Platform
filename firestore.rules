rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check auth
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the creator (for courses)
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if user has teacher role (simplified, real apps might check custom claims or user doc)
    // For now, relies on client-side role check + simple auth for write to classes, 
    // but better to check if existing doc createdBy matches.

    // Users
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Classes / Modules / Lessons
    // Teachers create/edit, Students read
    match /classes/{classId} {
      allow read: if isAuthenticated();
      // Allow create if auth, update/delete if owner
      allow create: if isAuthenticated(); 
      allow update, delete: if isOwner(resource.data.createdBy);
    }
    
    match /modules/{moduleId} {
      allow read: if isAuthenticated();
      // Ideally check if user owns the parent course, but for prototype:
      allow write: if isAuthenticated(); 
    }

    match /lessons/{lessonId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
    }

    match /comments/{commentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow delete: if isOwner(resource.data.userId);
    }

    // Progress Tracking - Students write their own
    match /lesson_progress/{progressId} {
        allow read: if isAuthenticated();
        // Allow write if the user is modifying their own progress
        allow write: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    match /enrollments/{enrollmentId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    match /assignments/{assignmentId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    match /notifications/{notificationId} {
        allow read: if request.auth != null; // Simplified from resource.data checks for now
        allow write: if request.auth != null;
    }

    match /exams/{examId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    match /exam_submissions/{submissionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    match /events/{eventId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    match /assignment_submissions/{submissionId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    // Mail System
    match /messages/{messageId} {
      // Allow read if user is sender or receiver
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid
      );
      // Allow create if authenticated
      allow create: if isAuthenticated();
      // Allow update (e.g. mark as read) if recipient
      allow update: if isAuthenticated() && (
        resource.data.receiverId == request.auth.uid ||
        resource.data.senderId == request.auth.uid 
      );
    }
  }
}
